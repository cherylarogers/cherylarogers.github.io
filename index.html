<!DOCTYPE html>
<html>
<head>
  <title>Tree Data Processor</title>

  <link rel="stylesheet" href="styles.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>

<a href="https://github.com/Rogers-Environmental-Remote-Sensing-Lab/Biomass"
   target="_blank" class="help-link">
  Help and more information on the calculations
</a>

<style>
  #result, #bulkResult { color: black; }
  label { color: black; font-weight: bold; }

  .help-link {
    position: fixed;
    top: 15px;
    right: 20px;
    font-size: 18px;
    font-weight: bold;
    text-decoration: underline;
    color: #0f100f;
  }
</style>

<!-- ===================================================== -->
<!-- =============== SINGLE TREE CALCULATOR ============== -->
<!-- ===================================================== -->

<h2>Biomass Calculator</h2>

<label for="dropdown">Species:</label>
<select id="dropdown"></select>

<div id="inputSection" style="display:none; margin-top: 20px;">
  <label>Height (m):</label>
  <input type="number" id="heightInput" step="0.01" value="0">

  <label>DBH (cm):</label>
  <input type="number" id="dbhInput" step="0.01" value="0">

  <button onclick="calculateBiomass()">Calculate Biomass</button>
</div>

<pre id="result"></pre>

<script>
const dropdown = document.getElementById("dropdown");
const inputSection = document.getElementById("inputSection");
const heightInput = document.getElementById("heightInput");
const dbhInput = document.getElementById("dbhInput");
const resultElement = document.getElementById("result");

let selectedSpecies = "";

// Load species list
d3.csv(
  "https://raw.githubusercontent.com/cherylarogers/cherylarogers.github.io/main/biomass/AGBnoHeight.csv"
).then(data => {

  const defaultOption = document.createElement("option");
  defaultOption.text = "Select a species";
  defaultOption.disabled = true;
  defaultOption.selected = true;
  dropdown.appendChild(defaultOption);

  data.forEach(d => {
    const opt = document.createElement("option");
    opt.text = d.speciesx;
    dropdown.appendChild(opt);
  });
});

dropdown.addEventListener("change", () => {
  selectedSpecies = dropdown.value;
  inputSection.style.display = "block";
});

function calculateBiomass() {

  const height = parseFloat(heightInput.value) || 0;
  const dbh = parseFloat(dbhInput.value) || 0;

  const csvUrl = height > 0
    ? "https://raw.githubusercontent.com/cherylarogers/cherylarogers.github.io/main/biomass/AGBwithheights.csv"
    : "https://raw.githubusercontent.com/cherylarogers/cherylarogers.github.io/main/biomass/AGBnoHeight.csv";

  d3.csv(csvUrl).then(data => {

    const row = data.find(d => d.speciesx === selectedSpecies);
    if (!row) return;

    let ywood=0,ybark=0,ystem=0,ybranches=0,yfoliage=0,ycrown1=0,ycrown2=0,ytotal=0;

    if (height <= 0) {
      ywood = +row.estimatebwood1 * (dbh ** +row.estimatebwood2);
      ybark = +row.estimatebbark1 * (dbh ** +row.estimatebbark2);
      ybranches = +row.estimatebbranches1 * (dbh ** +row.estimatebbranches2);
      yfoliage = +row.estimatebfoliage1 * (dbh ** +row.estimatebfoliage2);

      ystem = ywood + ybark;
      ycrown1 = ybranches + yfoliage;
      ycrown2 = ystem + ycrown1;
      ytotal = ycrown2;
    } else {
      ywood = +row.estimatebwood1 * (dbh ** +row.estimatebwood2) * (height ** +row.estimatebwood3);
      ybark = +row.estimatebbark1 * (dbh ** +row.estimatebbark2) * (height ** +row.estimatebbark3);
      ybranches = +row.estimatebbranches1 * (dbh ** +row.estimatebbranches2) * (height ** +row.estimatebbranches3);
      yfoliage = +row.estimatebfoliage1 * (dbh ** +row.estimatebfoliage2) * (height ** +row.estimatebfoliage3);

      ystem = ywood + ybark;
      ycrown1 = ybranches + yfoliage;
      ytotal = ystem + ycrown1;
    }

    resultElement.textContent =
      `ywood: ${ywood.toFixed(6)}\n` +
      `ybark: ${ybark.toFixed(6)}\n` +
      `ystem: ${ystem.toFixed(6)}\n` +
      `ybranches: ${ybranches.toFixed(6)}\n` +
      `yfoliage: ${yfoliage.toFixed(6)}\n` +
      `ycrown1: ${ycrown1.toFixed(6)}\n` +
      `ycrown2: ${ycrown2.toFixed(6)}\n` +
      `ytotal: ${ytotal.toFixed(6)}`;
  });
}
</script>

<hr>

<!-- ===================================================== -->
<!-- ================= BULK EXCEL PROCESSOR ============== -->
<!-- ===================================================== -->

<h3>Bulk Upload (Excel)</h3>

<input type="file" id="bulkFileInput" accept=".xlsx,.xls">
<button onclick="processFile()">Process File</button>

<pre id="bulkResult"></pre>

<script>
async function processFile() {

  const file = document.getElementById("bulkFileInput").files[0];
  if (!file) return;

  const agbNoHeight = await d3.csv(
    "https://raw.githubusercontent.com/cherylarogers/cherylarogers.github.io/main/biomass/AGBnoHeight.csv"
  );
  const agbWithHeight = await d3.csv(
    "https://raw.githubusercontent.com/cherylarogers/cherylarogers.github.io/main/biomass/AGBwithheights.csv"
  );

  const reader = new FileReader();
  reader.onload = e => {

    const wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
    const wsName = wb.SheetNames[0];
    const raw = XLSX.utils.sheet_to_json(wb.Sheets[wsName], { header: 1, defval: "" });

    // Headers row 15
    raw[14] = raw[14] || [];
    ["ywood","ybark","ystem","ybranches","yfoliage","ycrown1","ycrown2","ytotal"]
      .forEach((h,i)=> raw[14][5+i]=h);

    for (let r=15; r<raw.length; r++) {

      const species = String(raw[r][2]||"").trim();
      const height = parseFloat(raw[r][3]||0);
      const dbh = parseFloat(raw[r][4]||0);
      if (!species || dbh<=0) continue;

      const clean=s=>s.toLowerCase().trim();
      const src = height>0 ? agbWithHeight : agbNoHeight;
      const m = src.find(d=>clean(d.speciesx)===clean(species));
      if (!m) continue;

      let ywood,ybark,ybranches,yfoliage;
      if (height<=0) {
        ywood = +m.estimatebwood1*(dbh**+m.estimatebwood2);
        ybark = +m.estimatebbark1*(dbh**+m.estimatebbark2);
        ybranches = +m.estimatebbranches1*(dbh**+m.estimatebbranches2);
        yfoliage = +m.estimatebfoliage1*(dbh**+m.estimatebfoliage2);
      } else {
        ywood = +m.estimatebwood1*(dbh**+m.estimatebwood2)*(height**+m.estimatebwood3);
        ybark = +m.estimatebbark1*(dbh**+m.estimatebbark2)*(height**+m.estimatebbark3);
        ybranches = +m.estimatebbranches1*(dbh**+m.estimatebbranches2)*(height**+m.estimatebbranches3);
        yfoliage = +m.estimatebfoliage1*(dbh**+m.estimatebfoliage2)*(height**+m.estimatebfoliage3);
      }

      const ystem=ywood+ybark, ycrown1=ybranches+yfoliage, ytotal=ystem+ycrown1;

      [ywood,ybark,ystem,ybranches,yfoliage,ycrown1,"",ytotal]
        .forEach((v,i)=> raw[r][5+i]=typeof v==="number"?v.toFixed(6):"");
    }

    wb.Sheets[wsName]=XLSX.utils.aoa_to_sheet(raw);
    XLSX.writeFile(wb,file.name);
    document.getElementById("bulkResult").textContent="Bulk processing complete âœ”";
  };

  reader.readAsArrayBuffer(file);
}
</script>

</body>
</html>
